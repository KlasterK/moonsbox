name: Moonsbox Cross-Platform Build Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.13']

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch all the tags

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies and PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Run PyInstaller build
      run: |
        pyinstaller pyinst_moonsbox.spec
      shell: ${{ matrix.os == 'windows-latest' && 'powershell' || 'bash' }}

    - name: Get Version and Architecture Info
      id: version_info
      shell: bash
      run: |
        # Try to get version from last tag name
        VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        # If no tag found, get version from git commit hash
        if [ -z "$VERSION" ]; then
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Determine architecture
        ARCH=$(uname -m)
        PLATFORM="${{ matrix.os }}"
        
        # Normalize architecture name
        if [ "$PLATFORM" == "ubuntu-latest" ]; then PLATFORM="linux"; fi
        if [ "$PLATFORM" == "windows-latest" ]; then PLATFORM="windows"; fi
        if [ "$PLATFORM" == "macos-latest" ]; then PLATFORM="macos"; fi

        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "ARCH=$ARCH" >> $GITHUB_ENV
        echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

    - name: Move assets to dist/ folder
      shell: bash
      run: |
        cp -r assets/ dist/assets/

    - name: Create final artifact archive
      shell: bash
      run: |
        ARCHIVE_NAME="moonsbox-${{ env.VERSION }}-${{ env.PLATFORM }}-${{ env.ARCH }}"
        
        if [ "${{ env.PLATFORM }}" == "windows" ] || [ "${{ env.PLATFORM }}" == "macos" ]; then
          7z a -tzip "$ARCHIVE_NAME.zip" ./dist/*
          echo "ARTIFACT_PATH=$ARCHIVE_NAME.zip" >> $GITHUB_ENV
        else
          tar czvf "$ARCHIVE_NAME.tar.gz" -C dist/ .
          echo "ARTIFACT_PATH=$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARCHIVE_NAME }}
        path: ${{ env.ARTIFACT_PATH }}
